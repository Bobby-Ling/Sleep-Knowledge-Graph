(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-aiconsult-aiconsult"],{"2e3b":function(e,t,a){"use strict";var n=a("fd3e"),s=a.n(n);s.a},"711e":function(e,t,a){"use strict";a("6a54");var n=a("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=n(a("9591")),o=n(a("b7c7")),i=n(a("9b1b"));a("c223"),a("d4b5"),a("fd3c"),a("4db2"),a("bf0f"),a("c976"),a("4d8f"),a("7b97"),a("668a"),a("c5b7"),a("8ff5"),a("2378"),a("641a"),a("64e0"),a("cce3"),a("efba"),a("d009"),a("bd7d"),a("7edd"),a("d798"),a("f547"),a("5e54"),a("b60a"),a("8c18"),a("12973"),a("f991"),a("198e"),a("8557"),a("63b1"),a("1954"),a("1cf1"),a("4626"),a("5ac7"),a("f7a5"),a("9db6"),a("5c47"),a("2797");var r={data:function(){return{messages:[],inputValue:"",loading:!1,scrollTop:0,followupQueries:[],showFollowup:!1,session_id:"5b1ff5cb-39b2-4210-99f2-9c7e85d08322",expandedRefs:{},expandedDocs:{},followupAnimation:null,baseUrl:"http://bobby.ipyingshe.net:22630",docIndex:0,doc:{document_name:"",scoreFormatted:"",content:""}}},onLoad:function(){this.initChat(),this.getHistoryMessages()},methods:{initChat:function(){uni.request({url:"".concat(this.baseUrl,"/chat/").concat(this.session_id,"/init"),method:"POST",data:{content:"明白了。"},header:{"content-type":"application/json"},success:function(e){console.log("Chat initialized:",e.data)},fail:function(e){console.error("Init chat failed:",e),uni.showToast({title:"初始化失败",icon:"none"})}})},processMessages:function(e){var t=JSON.parse(JSON.stringify(e));return t.map((function(e){return"AI"===e.type&&e.references&&e.references.hint_documents&&(e.references.hint_documents=e.references.hint_documents.map((function(e){return(0,i.default)((0,i.default)({},e),{},{scoreFormatted:(100*e.score).toFixed(1),title:e.document_name||"参考文档"})}))),e}))},getHistoryMessages:function(){var e=this;uni.request({url:"".concat(this.baseUrl,"/chat/").concat(this.session_id,"/messages"),method:"GET",header:{"content-type":"application/json"},success:function(t){if(t.data&&t.data.messages){var a=e.processMessages(t.data.messages);e.setData({messages:a},(function(){e.scrollToBottom()}))}},fail:function(e){console.error("Get history failed:",e),uni.showToast({title:"获取历史记录失败",icon:"none"})}})},onInput:function(e){console.log(e.detail.value),this.setData({inputValue:e.detail.value})},toggleReferences:function(e){var t=e.currentTarget.dataset.messageIndex,a=(0,i.default)({},this.expandedRefs);a[t]=!a[t],this.setData({expandedRefs:a})},toggleDocument:function(e){var t=e.currentTarget.dataset,a=t.messageIndex,n=t.docIndex,s="".concat(a,"-").concat(n),o=(0,i.default)({},this.expandedDocs);o[s]=!o[s],this.setData({expandedDocs:o})},sendMessage:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.loading){var a="";if("string"===typeof t?a=t:"string"===typeof this.inputValue&&(a=this.inputValue),a&&0!==a.length){var n={content:a,type:"Human"},i={content:"",type:"AI",references:null};this.setData({messages:[].concat((0,o.default)(this.messages),[n,i]),inputValue:"",loading:!0,showFollowup:!1,followupQueries:[]}),this.scrollToBottom(),console.log(this.datamessages);var r=this.messages.length-1,d="",l=function(e){var t=new Uint8Array(e);return String.fromCharCode.apply(null,t)},c=function(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;e.setData({messages:t},(function(){e.scrollToBottom(),a&&a()}))},f=uni.request({url:"".concat(this.baseUrl,"/chat/").concat(this.session_id,"/messages/stream"),method:"POST",data:{content:a},header:{"content-type":"application/json"},enableChunked:!0,success:function(){},fail:function(t){console.error("Send message failed:",t),uni.showToast({title:"发送失败",icon:"none",duration:2e3}),e.setData({loading:!1})},complete:function(){e.setData({loading:!1})}}),u=this;f.onChunkReceived((function(t){try{var a=l(t.data);d+=a;while(d.includes("\n\n")){var n=d.split("\n\n"),i=(0,s.default)(n),f=i[0],g=i.slice(1);if(d=g.join("\n\n"),f.startsWith("data: ")){var p=f.slice(6);if("[DONE]"===p){var m=u.processMessages(u.messages);return void u.setData({messages:m})}try{var b=JSON.parse(p),v=(0,o.default)(e.messages);switch(b.type){case"references":v[r].references=b.references,c(v);break;case"content":v[r].content+=b.content,c(v);break;case"followup_query":var h=e.followupQueries||[];h.includes(b.query)||(e.setData({followupQueries:[].concat((0,o.default)(h),[b.query]),showFollowup:!0}),console.log(e.followupQueries));break;default:console.log("Unknown message type:",b.type);break}}catch(w){console.log("CatchClause",w),console.log("CatchClause",w),d=f.slice(6)+"\n\n"+d;break}}}}catch(k){console.log("CatchClause",k),console.log("CatchClause",k),console.error("Process chunk failed:",k),uni.showToast({title:"处理响应失败",icon:"none",duration:2e3})}}))}}},handleFollowup:function(e){var t=e.currentTarget.dataset.query;"string"===typeof t&&t.length>0&&this.sendMessage(t)},scrollToBottom:function(){var e=this;this.$nextTick((function(){uni.createSelectorQuery().in(uni).select(".chat-container").boundingClientRect().selectAll(".message").boundingClientRect().exec((function(t){if(t[0]&&t[1]){var a=t[0].height,n=0;t[1].forEach((function(e){n+=e.height})),e.setData({scrollTop:Math.max(0,n-a+100)})}}))}))},animateFollowup:function(){var e=uni.createAnimation({duration:300,timingFunction:"ease"});e.translateY(0).opacity(1).step(),this.setData({followupAnimation:e.export()})},onInputFocus:function(){console.log("onInputFocus"),this.setData({showFollowup:!1})},onInputBlur:function(){console.log("onInputBlur"),this.followupQueries.length>0&&this.setData({showFollowup:!0}),console.log(this.followupQueries)}}};t.default=r},"784c":function(e,t,a){var n=a("c86c");t=n(!1),t.push([e.i,".container[data-v-bd5f445a]{height:100vh;display:flex;flex-direction:column;background:#f5f5f5}.chat-container[data-v-bd5f445a]{flex:1;padding:%?20?%;overflow-y:auto}.messages[data-v-bd5f445a]{padding-bottom:%?20?%}.message[data-v-bd5f445a]{display:flex;margin-bottom:%?20?%;-webkit-animation:fadeIn-data-v-bd5f445a .3s ease;animation:fadeIn-data-v-bd5f445a .3s ease}@-webkit-keyframes fadeIn-data-v-bd5f445a{from{opacity:0;-webkit-transform:translateY(10px);transform:translateY(10px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes fadeIn-data-v-bd5f445a{from{opacity:0;-webkit-transform:translateY(10px);transform:translateY(10px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}\n\n/* AI消息样式 */.message.ai[data-v-bd5f445a]{flex-direction:row}\n\n/* 用户消息样式 */.message.user[data-v-bd5f445a]{flex-direction:row-reverse}.avatar[data-v-bd5f445a]{width:%?80?%;height:%?80?%;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:%?28?%;flex-shrink:0;position:relative;overflow:hidden}.avatar.ai[data-v-bd5f445a]{background:linear-gradient(135deg,#1890ff,#096dd9)}.user-avatar[data-v-bd5f445a]{background:linear-gradient(135deg,#52c41a,#389e0d);margin-right:%?40?%}.avatar.ai[data-v-bd5f445a]::before{content:\"\";position:absolute;width:%?40?%;height:%?40?%;background:#fff;mask-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2L2 7l10 5 10-5-10-5z' fill='currentColor'/%3E%3Cpath d='M2 17l10 5 10-5M2 12l10 5 10-5' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\");mask-size:contain;mask-repeat:no-repeat;mask-position:center;-webkit-mask-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2L2 7l10 5 10-5-10-5z' fill='currentColor'/%3E%3Cpath d='M2 17l10 5 10-5M2 12l10 5 10-5' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E\");-webkit-mask-size:contain;-webkit-mask-repeat:no-repeat;-webkit-mask-position:center}.user-avatar[data-v-bd5f445a]::before{content:\"\";position:absolute;width:%?40?%;height:%?40?%;background:#fff;mask-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2a7.2 7.2 0 01-6-3.22c.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 01-6 3.22z' fill='currentColor'/%3E%3C/svg%3E\");mask-size:contain;mask-repeat:no-repeat;mask-position:center;-webkit-mask-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2a7.2 7.2 0 01-6-3.22c.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 01-6 3.22z' fill='currentColor'/%3E%3C/svg%3E\");-webkit-mask-size:contain;-webkit-mask-repeat:no-repeat;-webkit-mask-position:center}.content[data-v-bd5f445a]{margin:0 %?20?%;max-width:70%;padding:%?20?%;border-radius:%?10?%;background:#fff;box-shadow:0 %?2?% %?8?% rgba(0,0,0,.1);font-size:%?28?%;line-height:1.5}\n\n/* 用户消息气泡样式 */.user-content[data-v-bd5f445a]{background:#95ec69!important;margin-right:%?20?%;margin-left:0}\n\n/* AI消息气泡样式 */.message.ai .content[data-v-bd5f445a]{background:#fff;margin-left:%?20?%;margin-right:0}\n\n/* 参考知识样式优化 */.references[data-v-bd5f445a]{margin-top:%?20?%;border-top:1px solid rgba(0,0,0,.1)}.references-header[data-v-bd5f445a]{display:flex;align-items:center;justify-content:space-between;padding:%?20?% 0;cursor:pointer}.references-left[data-v-bd5f445a]{display:flex;align-items:center}.references-title[data-v-bd5f445a]{font-size:%?28?%;color:#333;font-weight:500}.reference-count[data-v-bd5f445a]{font-size:%?24?%;color:#666;margin-left:%?-260?%;background:#f0f2f5;padding:%?4?% %?12?%;border-radius:%?20?%}.expand-button[data-v-bd5f445a]{display:flex;align-items:center;padding:%?8?% %?16?%;background:#f5f7fa;border-radius:%?24?%;transition:all .3s ease}.expand-button[data-v-bd5f445a]:active{background:#e8eaed}.expand-text[data-v-bd5f445a]{font-size:%?24?%;color:#666;margin-right:%?8?%}.expand-arrow[data-v-bd5f445a]{width:%?16?%;height:%?16?%;border-right:%?3?% solid #666;border-bottom:%?3?% solid #666;-webkit-transform:rotate(45deg);transform:rotate(45deg);transition:-webkit-transform .3s ease;transition:transform .3s ease;transition:transform .3s ease,-webkit-transform .3s ease;margin-top:%?-4?%}.expand-button.expanded .expand-arrow[data-v-bd5f445a]{-webkit-transform:rotate(-135deg);transform:rotate(-135deg);margin-top:%?4?%}\n\n/* 展开动画 */.references-content[data-v-bd5f445a]{-webkit-animation:slideDown-data-v-bd5f445a .3s ease;animation:slideDown-data-v-bd5f445a .3s ease;background:#f9f9f9;border-radius:%?12?%;margin-top:%?12?%}\n\n/* 参考文档项样式优化 */.reference-item[data-v-bd5f445a]{margin:%?12?%;background:#fff;border-radius:%?8?%;box-shadow:0 %?2?% %?8?% rgba(0,0,0,.05)}.ref-header[data-v-bd5f445a]{display:flex;align-items:center;padding:%?16?%;cursor:pointer;position:relative}.ref-header[data-v-bd5f445a]::after{content:\"\";position:absolute;right:%?16?%;width:%?12?%;height:%?12?%;border-right:%?2?% solid #999;border-bottom:%?2?% solid #999;-webkit-transform:rotate(45deg);transform:rotate(45deg);transition:-webkit-transform .3s ease;transition:transform .3s ease;transition:transform .3s ease,-webkit-transform .3s ease}.ref-header.expanded[data-v-bd5f445a]::after{-webkit-transform:rotate(-135deg);transform:rotate(-135deg)}.doc-name[data-v-bd5f445a]{flex:1;font-size:%?26?%;color:#333;margin-right:%?40?%}.doc-score[data-v-bd5f445a]{font-size:%?24?%;color:#1890ff;background:rgba(24,144,255,.1);padding:%?4?% %?12?%;border-radius:%?16?%;margin-right:%?30?%}.ref-content[data-v-bd5f445a]{padding:%?16?%;font-size:%?26?%;line-height:1.6;color:#666;border-top:1px solid rgba(0,0,0,.06);background:#fafafa}.input-container[data-v-bd5f445a]{padding:%?20?%;background:#fff;border-top:%?1?% solid #e8e8e8}.followup-container[data-v-bd5f445a]{margin-bottom:%?20?%;opacity:0;-webkit-transform:translateY(%?20?%);transform:translateY(%?20?%)}.followup-item[data-v-bd5f445a]{display:inline-block;margin:0 %?10?% %?10?% 0;padding:%?10?% %?20?%;background:#f0f2f5;border-radius:%?30?%;font-size:%?24?%;color:#666}.input-wrapper[data-v-bd5f445a]{display:flex;align-items:flex-end;background:#f5f5f5;border-radius:%?36?%;padding:%?20?%;height:%?50?%}.input[data-v-bd5f445a]{flex:1;font-size:%?28?%;line-height:1.5;padding:0;background:transparent}.send-btn[data-v-bd5f445a]{width:%?70?%;height:%?70?%;padding:0;margin:0 0 0 %?20?%;background:#e8e8e8;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .3s;top:%?10?%}.send-btn.active[data-v-bd5f445a]{background:linear-gradient(135deg,#1890ff,#096dd9)}.send-btn[data-v-bd5f445a]::before{content:\"\";position:absolute;width:%?40?%;height:%?40?%;background:#999;transition:all .3s;mask-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z' fill='currentColor'/%3E%3C/svg%3E\");mask-size:contain;mask-repeat:no-repeat;mask-position:center;-webkit-mask-image:url(\"data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2 .01 7z' fill='currentColor'/%3E%3C/svg%3E\");-webkit-mask-size:contain;-webkit-mask-repeat:no-repeat;-webkit-mask-position:center}.send-btn.active[data-v-bd5f445a]::before{background:#fff}.loading[data-v-bd5f445a]::after{content:\"\";display:inline-block;width:%?40?%;height:%?40?%;margin-left:%?10?%;border:%?4?% solid #f3f3f3;border-top:%?4?% solid #3498db;border-radius:50%;-webkit-animation:spin-data-v-bd5f445a 1s linear infinite;animation:spin-data-v-bd5f445a 1s linear infinite}@-webkit-keyframes slideDown-data-v-bd5f445a{from{opacity:0;-webkit-transform:translateY(%?-10?%);transform:translateY(%?-10?%)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes slideDown-data-v-bd5f445a{from{opacity:0;-webkit-transform:translateY(%?-10?%);transform:translateY(%?-10?%)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes spin-data-v-bd5f445a{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes spin-data-v-bd5f445a{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}",""]),e.exports=t},"93d4":function(e,t,a){"use strict";a.r(t);var n=a("711e"),s=a.n(n);for(var o in n)["default"].indexOf(o)<0&&function(e){a.d(t,e,(function(){return n[e]}))}(o);t["default"]=s.a},9591:function(e,t,a){"use strict";a("6a54"),Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return(0,n.default)(e)||(0,s.default)(e)||(0,o.default)(e)||(0,i.default)()};var n=r(a("6242")),s=r(a("d14d")),o=r(a("5d6b")),i=r(a("b7b1"));function r(e){return e&&e.__esModule?e:{default:e}}},"9b63":function(e,t,a){"use strict";a.d(t,"b",(function(){return n})),a.d(t,"c",(function(){return s})),a.d(t,"a",(function(){}));var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("v-uni-view",{staticClass:"container"},[a("v-uni-scroll-view",{staticClass:"chat-container",attrs:{"scroll-y":!0,enhanced:!0,"show-scrollbar":!1,"scroll-with-animation":!0,"scroll-top":e.scrollTop,"scroll-into-view":"msg"+(e.messages.length-1)}},[a("v-uni-view",{staticClass:"messages"},e._l(e.messages,(function(t,n){return a("v-uni-view",{key:n,class:"message "+("Human"===t.type?"user":"ai")+" "+(e.loading&&n===e.messages.length-1?"loading":""),attrs:{id:"msg"+n}},["Human"===t.type?a("v-uni-view",{staticClass:"avatar user-avatar"}):e._e(),"AI"===t.type?a("v-uni-view",{class:"avatar "+("AI"===t.type?"ai":"user-avatar")}):e._e(),a("v-uni-view",{class:"content "+("AI"===t.type?"ai-content":"user-content")},[a("v-uni-text",{attrs:{"user-select":!0}},[e._v(e._s(t.content))]),"AI"===t.type&&t.references&&t.references.hint_documents.length>0?a("v-uni-view",{staticClass:"references"},[a("v-uni-view",{staticClass:"references-header",attrs:{"data-message-index":n},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.toggleReferences.apply(void 0,arguments)}}},[a("v-uni-text",{staticClass:"references-title"},[e._v("参考知识")]),a("v-uni-view",{staticClass:"reference-count"},[e._v(e._s(t.references.hint_documents.length)+"条")]),a("v-uni-view",{class:"expand-icon "+(e.expandedRefs[n]?"expanded":"")},[a("v-uni-text",{staticClass:"expand-text"},[e._v(e._s(e.expandedRefs[n]?"收起":"展开"))])],1)],1),e.expandedRefs[n]?a("v-uni-view",{staticClass:"references-content"},e._l(t.references.hint_documents,(function(t,s){return a("v-uni-view",{key:s,staticClass:"reference-item"},[a("v-uni-view",{class:"ref-header "+(e.expandedDocs[n+"-"+s]?"expanded":""),attrs:{"data-message-index":n,"data-doc-index":s},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.toggleDocument.apply(void 0,arguments)}}},[a("v-uni-text",{staticClass:"doc-name"},[e._v(e._s(t.document_name))]),a("v-uni-text",{staticClass:"doc-score"},[e._v("相关度："+e._s(t.scoreFormatted)+"%")]),a("v-uni-view",{staticClass:"expand-icon"})],1),e.expandedDocs[n+"-"+s]?a("v-uni-view",{class:"ref-content "+(e.expandedDocs[n+"-"+s]?"expanded":"")},[e._v(e._s(t.content))]):e._e()],1)})),1):e._e()],1):e._e()],1)],1)})),1)],1),a("v-uni-view",{staticClass:"input-container"},[e.followupQueries&&e.followupQueries.length>0?a("v-uni-view",{staticClass:"followup-container",attrs:{animation:e.followupAnimation}},e._l(e.followupQueries,(function(t,n){return a("v-uni-view",{key:n,staticClass:"followup-item",attrs:{"data-query":t||""},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.handleFollowup.apply(void 0,arguments)}}},[e._v(e._s(t||""))])})),1):e._e(),a("v-uni-view",{staticClass:"input-wrapper"},[a("v-uni-textarea",{staticClass:"input",attrs:{value:e.inputValue,"auto-height":!0,maxlength:"500",placeholder:"请描述您的问题...",disabled:e.loading,"cursor-spacing":"40","show-confirm-bar":!1,"adjust-position":!1},on:{input:function(t){arguments[0]=t=e.$handleEvent(t),e.onInput.apply(void 0,arguments)},focus:function(t){arguments[0]=t=e.$handleEvent(t),e.onInputFocus.apply(void 0,arguments)},blur:function(t){arguments[0]=t=e.$handleEvent(t),e.onInputBlur.apply(void 0,arguments)}}}),a("v-uni-button",{class:"send-btn "+(e.inputValue&&e.inputValue.length>0?"active":""),attrs:{disabled:e.loading||!(e.inputValue&&e.inputValue.length>0)},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.sendMessage.apply(void 0,arguments)}}})],1)],1)],1)},s=[]},"9bd4":function(e,t,a){"use strict";a.r(t);var n=a("9b63"),s=a("93d4");for(var o in s)["default"].indexOf(o)<0&&function(e){a.d(t,e,(function(){return s[e]}))}(o);a("2e3b");var i=a("828b"),r=Object(i["a"])(s["default"],n["b"],n["c"],!1,null,"bd5f445a",null,!1,n["a"],void 0);t["default"]=r.exports},fd3e:function(e,t,a){var n=a("784c");n.__esModule&&(n=n.default),"string"===typeof n&&(n=[[e.i,n,""]]),n.locals&&(e.exports=n.locals);var s=a("967d").default;s("4463beb4",n,!0,{sourceMap:!1,shadowMode:!1})}}]);